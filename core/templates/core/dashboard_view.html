{% extends 'core/dashboard.html' %}
{% load static %}
{% load humanize %}

{% block specific_css %}
<link href="{% static 'dist/assets/vendor/apexcharts/apexcharts.css' %}" rel="stylesheet" />
{% endblock %}

{% block title %}Dashboard{% endblock %}
{% block title1 %}GlobalGes{% endblock %}
{% block title2 %}Finanzas{% endblock %}
{% block title3 %}Dashboard{% endblock %}

{% block content %}
<div class="row">
  <!-- TARJETAS: CONTROL PESOS -->
  <div class="col-xxl-3 col-sm-6">
      <div class="card widget-flat text-bg-success">
          <div class="card-body">
              <div class="float-end">
                  <i class="ri-bank-line widget-icon"></i>
              </div>
              <h6 class="text-uppercase mt-0">Saldo Bancario ARS</h6>
              <h2 class="my-2">{{ saldo_cta_pesos|floatformat:2|intcomma }}</h2>
          </div>
      </div>
  </div>

  <div class="col-xxl-3 col-sm-6">
      <div class="card widget-flat text-bg-success">
          <div class="card-body">
              <div class="float-end">
                  <i class="ri-money-dollar-circle-line widget-icon"></i>
              </div>
              <h6 class="text-uppercase mt-0">Otros Ingresos (Cert. IG)</h6>
              <h2 class="my-2">{{ otros_ingresos|floatformat:2|intcomma }}</h2>
          </div>
      </div>
  </div>

  <div class="col-xxl-3 col-sm-6">
      <div class="card widget-flat text-bg-danger">
          <div class="card-body">
              <div class="float-end">
                  <i class="ri-hand-coin-line widget-icon"></i>
              </div>
              <h6 class="text-uppercase mt-0">Cuentas por Cobrar (Pesos)</h6>
              <h2 class="my-2">{{ total_deuda_por_cobrar_pesos|floatformat:2|intcomma }}</h2>
          </div>
      </div>
  </div>

  <div class="col-xxl-3 col-sm-6">
      <div class="card widget-flat text-bg-primary">
          <div class="card-body">
              <div class="float-end">
                  <i class="ri-wallet-3-line widget-icon"></i>
              </div>
              <h6 class="text-uppercase mt-0">Cuentas a Pagar (Pesos)</h6>
              <h2 class="my-2">{{ total_deudas_a_pagar_pesos|floatformat:2|intcomma }}</h2>
          </div>
      </div>
  </div>

  <div class="col-xxl-3 col-sm-6">
      <div class="card widget-flat {% if saldo_real_pesos >= 0 %}text-bg-success{% else %}text-bg-danger{% endif %}">
          <div class="card-body">
              <div class="float-end">
                  <i class="ri-equalizer-line widget-icon"></i>
              </div>
              <h6 class="text-uppercase mt-0">Saldo Real (Pesos)</h6>
              <h2 class="my-2">{{ saldo_real_pesos|floatformat:2|intcomma }}</h2>
          </div>
      </div>
  </div>
</div>

<hr class="my-4">

<div class="row">
  <!-- TARJETAS: CONTROL DÓLARES -->
  <div class="col-xxl-3 col-sm-6">
      <div class="card widget-flat text-bg-success">
          <div class="card-body">
              <div class="float-end">
                  <i class="ri-bank-line widget-icon"></i>
              </div>
              <h6 class="text-uppercase mt-0">Saldo Bancario USD</h6>
              <h2 class="my-2">{{ saldo_cta_dolares|floatformat:2|intcomma }}</h2>
          </div>
      </div>
  </div>

  <div class="col-xxl-3 col-sm-6">
      <div class="card widget-flat text-bg-danger">
          <div class="card-body">
              <div class="float-end">
                  <i class="ri-hand-coin-line widget-icon"></i>
              </div>
              <h6 class="text-uppercase mt-0">Cuentas por Cobrar (Dólares)</h6>
              <h2 class="my-2">{{ total_deuda_por_cobrar_dolares|floatformat:2|intcomma }}</h2>
          </div>
      </div>
  </div>

  <div class="col-xxl-3 col-sm-6">
      <div class="card widget-flat text-bg-primary">
          <div class="card-body">
              <div class="float-end">
                  <i class="ri-wallet-3-line widget-icon"></i>
              </div>
              <h6 class="text-uppercase mt-0">Cuentas a Pagar (Dólares)</h6>
              <h2 class="my-2">{{ total_deudas_a_pagar_dolares|floatformat:2|intcomma }}</h2>
          </div>
      </div>
  </div>

  <div class="col-xxl-3 col-sm-6">
      <div class="card widget-flat {% if saldo_real_dolares >= 0 %}text-bg-success{% else %}text-bg-danger{% endif %}">
          <div class="card-body">
              <div class="float-end">
                  <i class="ri-equalizer-line widget-icon"></i>
              </div>
              <h6 class="text-uppercase mt-0">Saldo Real (Dólares)</h6>
              <h2 class="my-2">{{ saldo_real_dolares|floatformat:2|intcomma }}</h2>
          </div>
      </div>
  </div>
</div>

<hr class="my-4">

<div class="row">
  <!-- GRÁFICO: INGRESOS, EGRESOS, SALDOS -->
  <div class="col-12">
    <div class="card">
      <div class="card-header">
          <h5 class="header-title mb-0">Ingresos, Egresos y Saldos por Mes (Conciliados)</h5>
      </div>
      <div class="card-body">
          <div id="grafico-saldos" class="apex-charts" style="height: 400px;"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block specific_js %}
<script src="{% static 'dist/assets/vendor/apexcharts/apexcharts.min.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    fetch("{% url 'dashboard_data' %}", {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(response => response.json())
    .then(data => {
        const meses = data.map(item => item.mes);
        const ingresos = data.map(item => item.ingresos);
        const egresos = data.map(item => item.egresos);
        const saldos = data.map(item => item.saldo);

        var options = {
            chart: {
                height: 400,
                type: 'bar',
                toolbar: { show: false },
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '55%',
                    endingShape: 'rounded'
                }
            },
            dataLabels: { enabled: false },
            stroke: { show: true, width: 2, colors: ['transparent'] },
            series: [
                {
                    name: 'Ingresos',
                    data: ingresos
                },
                {
                    name: 'Egresos',
                    data: egresos
                },
                {
                    name: 'Saldo',
                    data: saldos
                }
            ],
            xaxis: {
                categories: meses,
                labels: {
                    rotate: -45,
                    style: { fontSize: '12px', fontWeight: 600 }
                }
            },
            yaxis: {
                title: { text: 'Montos ($)' },
                labels: {
                    formatter: function (val) {
                        return "$" + parseInt(val);
                    }
                }
            },
            fill: {
                opacity: 1
            },
            colors: ['#28a745', '#dc3545', '#007bff'],
            tooltip: {
                y: { formatter: function (val) { return "$" + val; } }
            },
            legend: {
                position: 'top',
                horizontalAlign: 'center'
            }
        };

        var chart = new ApexCharts(document.querySelector("#grafico-saldos"), options);
        chart.render();
    })
    .catch(error => console.error('Error al cargar datos del gráfico:', error));
});
</script>
{% endblock %}
